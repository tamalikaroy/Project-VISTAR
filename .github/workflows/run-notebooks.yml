name: Run Notebooks

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  execute-notebooks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt || true
          pip install nbformat nbconvert
      - name: Execute notebooks
        run: |
          python - <<PY
import nbformat, glob, sys
from nbconvert.preprocessors import ExecutePreprocessor
for nb in glob.glob("Notebooks/*.ipynb"):
    print("Running", nb)
    nb_obj = nbformat.read(nb, as_version=4)
    ep = ExecutePreprocessor(timeout=600, kernel_name="python3")
    try:
        ep.preprocess(nb_obj, {'metadata': {'path': 'Notebooks/'}})
    except Exception as e:
        print("ERROR while running", nb)
        raise
print("All done")
PY
